<script type="text/javascript">

function triminput(inputcontrol){
	var allnames = inputcontrol.value;
	allnames = allnames.trim();
	allnames = allnames.replace(/\s+|\n+|\r\n+/g, '\n');
	
	inputcontrol.value = allnames;
	return allnames;
}

var submiting = false;

function form_submit(inputname, formid){
	if (submiting){
		showbox("提交的请求正在处理中，请稍等");
		return;
	}
	submiting = true;
	var inputcontrol = EID(formid)[inputname];
	triminput(inputcontrol);
	$.post(EID(formid).action, $('#' + formid).serialize(), function(result){
		submiting = false;
		if (!check_auth(result))
			return;
		EID(formid).reset();
		onblockmin();
	});
}

function fillname(name, inputcontrol){
	var allnames = triminput(inputcontrol);
	
	if (allnames.length > 0)
		allnames = allnames.trim() +  '\n';
	if (name != '')
	{
		if (allnames.indexOf(name + '\n') == -1 && allnames.indexOf(name + '\r') == -1)
		{
			allnames += name + '\n';
		}
	}
	inputcontrol.value = allnames;
}
function showmail(name){
	EID('mailbox').style.display='block';
	EID('kickbox').style.display='none';
	EID('shutbox').style.display='none';
	fillname(name, EID('mailform').names);
}
function showkick(name){
	EID('kickbox').style.display='block'
	EID('mailbox').style.display='none';
	EID('shutbox').style.display='none';
	fillname(name, EID('kickform').names);
}
function showshut(name){
	EID('shutbox').style.display='block';
	EID('kickbox').style.display='none';
	EID('mailbox').style.display='none';
	fillname(name, EID('shutform').names);
}
function cancel(){
	EID('mailbox').style.display='none';
	EID('kickbox').style.display='none';
	EID('shutbox').style.display='none';
	EID('mailform').names.value = '';
	EID('kickform').names.value = '';
	EID('shutform').names.value = '';
}

function onblockmin(){
	
	EID('kickform').kick_block.disabled = EID('kickform').block_acc.checked;
			
	if (EID('kickform').kick_block.checked || EID('kickform').block_acc.checked){
		EID('blockbox').style.display = "block";
	}else{
		EID('blockbox').style.display = "none";
	}
}

function doblockedsearch(){
	$.get("/search_block", {key: $("#blockedsearch").val().trim(), type:"char"},
		function(result){
			if (!check_auth(result))
				return;
			$("#blocked_list").html(result);
		});
}

function dochatblockedsearch_chat(){
	$.get("/search_block", {key: $("#chatblockedsearch").val().trim(), type:"chat"},
		function(result){
			if (!check_auth(result))
				return;
			$("#blocked_list_chat").html(result);
		});
}

function unblock(charinfo){
	var L = charinfo.split('#');
	var type = L[2];
	if (type == 'char'){
		if (L[0] == '*')
			type = 'account';
	}else if (type == 'chat'){
		if (L[0] == '*')
			type = 'account_chat';
		else
			type = 'char_chat';
	}
	$.post("/unblock", {block_type:type, charid:L[0], acc:L[1]}, function(result){
		if (!check_auth(result))
			return;
		if (type.indexOf("chat") >= 0)
			dochatblockedsearch_chat();
		else
			doblockedsearch();
	});
}


</script>
<div class="div_normal">
  <div class="bkdiv">
    <table border="0" cellspacing="10">
      <tr>
        <td colspan="2"><strong>批量操作</strong></td>
      </tr>
      <tr>
        <td colspan="2"><a href="javascript:showmail('')">系统邮件</a> &nbsp;<a href="javascript:showkick('')">踢角色</a> &nbsp;<a href="javascript:showshut('')">禁言</a></td>
      </tr>
      <tr>
        <td><hr /></td>
      </tr>
      <tr>
        <td><strong>玩家列表</strong></td>
      </tr>
      <tr>
        <td><input class="round" type="text" id="charsearch" value="" oninput="dosearch()" onpropertychange="dosearch()" maxlength="64"/>
          <a id="searchbtn" href="javascript:dosearch()" class="abutton">搜索</a><br/>
          <input type="checkbox" id="searchtype" value="checked" onchange="if (EID('charsearch').value!='') dosearch()" checked="checked"/>
          <label>只搜索在线玩家</label>
          </td>
      </tr>
      <tr>
        <td><div id="playerlist_table" style="height:500px; overflow:auto"> </div></td>
      </tr>
    </table>
  </div>
  <div class="bkdiv div_0">
    <table border="0" cellspacing="0" cellpadding="10">
      <tr>
        <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
        <td><div class="bkdiv nodisp" id="mailbox"> <strong>发送系统邮件</strong>
            <ul>
              <li>请输入发件人、收件人名单（一行一个名字，留空表示发全区）<br />主题、内容</li>
              <li>最后点击"发送"</li>
            </ul>
            <form action="/sysmail" method="post" id="mailform">
            <label>发件人：</label>
              <input class="round" name="sender_name"  type="text" maxlength="64"/>
              <br/>
              <br/>
              <label>收件人：</label>
              <br/>
              <textarea name="names" cols="64" rows="10" wrap="virtual"></textarea>
              <br/>
              <br/>
              <label>主题：</label>
              <input class="round" name="title" type="text" maxlength="1024">
              </input>
              <br/>
              <br/>
              <label>内容：</label>
              <br/>
              <textarea name="content" cols="64" rows="10" wrap="off"></textarea>
              <label>附件：</label>
              <br/>
              <textarea name="attach" cols="64" rows="10" wrap="off"></textarea>
              <p align="right"> <a href="javascript:cancel()" class="abutton">取消</a>&nbsp; <a href="javascript:form_submit('names', 'mailform')" class="abutton">发送</a> </p>
            </form>
          </div>
          <div class="bkdiv nodisp" id="kickbox">
            <table border="0" cellspacing="0" cellpadding="0">
              <tr>
                <td nowrap="nowrap" valign="top"><strong>踢掉角色</strong>
                  <ul>
                    <li>请输入要踢掉的名单（一行一个名字）</li>
                    <li>若选中"并且封停角色"则以下角色在本区都被封禁</li>
                    <li>若选中"并且封停账号"则以下角色名所属账号下的所有角色在本区都被封禁</li>
                    <li>最后点击"踢掉"</li>
                  </ul>
                  <form action="/kick" method="post" id="kickform">
                    <textarea name="names" cols="64" rows="10" wrap="virtual"></textarea>
                    <br />
                    <br />
                    <input name="kick_block" type="checkbox" onclick="onblockmin()" value="blocked"/>
                    <label>并且封停角色</label>
                    <br />
                    <input name="block_acc" type="checkbox" onclick="onblockmin()" value="blocked"/>
                    <label>并且封停账号</label>
                    <br />
                    <br />
                    <div style="display:none" id="blockbox">
                      <label>时长</label>
                      &nbsp;
                      <input class="round" name="block_min" type="text" onKeyDown="if(event.keyCode==13){form_submit('names', 'kickform');return false;}"/>
                      &nbsp;
                      <label>分钟</label>
                    </div>
                    <p align="right"> <a href="javascript:cancel()" class="abutton">取消</a>&nbsp; <a href="javascript:form_submit('names', 'kickform')" class="abutton">踢掉</a> </p>
                  </form></td>
                <td valign="top" align="center"><p style="width:1px;height:500px;background:#999"></p>
                  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td nowrap="nowrap" valign="top"> 已封停的对象：
                  <input class="round" type="text" id="blockedsearch" value="" oninput="doblockedsearch()" onpropertychange="doblockedsearch()" maxlength="32"/>
                  <a href="javascript:doblockedsearch()" class="abutton">搜索</a><br/>
                  <br/>
                  <div id="blocked_list"></div>
              </tr>
            </table>
          </div>
          <div class="bkdiv nodisp" id="shutbox">
            <table border="0" cellspacing="0" cellpadding="0">
              <tr>
                <td nowrap="nowrap" valign="top"><strong>禁言</strong>
                  <ul>
                    <li>请输入禁言名单（一行一个名字）、禁言时长</li>
                    <li>若选中“对账号禁言”则以下角色名所属账号下的所有角色在本区都不可聊天</li>
                    <li>最后点击"禁言生效"</li>
                  </ul>
                  <form action="/shutup" method="post"  id="shutform">
                    <textarea name="names" cols="64" rows="10" wrap="virtual"></textarea>
                    <br />
                    <br />
                    <label>时长</label>
                    &nbsp;
                    <input class="round" name="block_min" type="text" onKeyDown="if(event.keyCode==13){form_submit('names', 'shutform');return false;}"/>
                    &nbsp;
                    <label>分钟</label>
                    <br />
                    <br />
                    <input name="block_acc" type="checkbox" value="blocked"/>
                    <label>对账号禁言</label>
                    <p align="right"> <a href="javascript:cancel()" class="abutton">取消</a>&nbsp; <a href="#" onClick="form_submit('names', 'shutform')" class="abutton">禁言生效</a> </p>
                  </form></td>
                <td valign="top" align="center"><p style="width:1px;height:500px;background:#999"></p>
                  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td nowrap="nowrap" valign="top"> 已禁言的对象：
                  <input class="round" type="text" id="chatblockedsearch" value="" oninput="dochatblockedsearch_chat()" onpropertychange="dochatblockedsearch_chat()" 
                 maxlength="32" />
                  <a href="javascript:dochatblockedsearch_chat()" class="abutton">搜索</a><br/>
                  <br/>
                  <div id="blocked_list_chat"></div></td>
              </tr>
            </table>
          </div></td>
      </tr>
    </table>
  </div>
</div>
<script type="text/javascript">
function dosearch(){
		$.get("/playersearch", {key: $("#charsearch").val().trim(), type:EID("searchtype").checked},
		function(result){
			if (!check_auth(result))
				return;
			$("#playerlist_table").html(result);
		});
}

</script>