var express = require('express');
var util = require('util');
var gmlog = require("gmlog");
var jsutil = require("jsutil");
var gzippo = require('gzippo');
var fs = require('fs');
var MemoryStore = express.session.MemoryStore;
var sessionStroe = new MemoryStore();
var money = require('money');
var type1 = '10元套餐';
var type2 = "12元加荤套餐";

var PICPATH = "E:/kuaipan/pic/bz";
var dingdan_lists = [];
var dingdan_list_links = "";

var PROMOT_START = '<center><br/><br/><br/><br/><font size="32">';
var PROMOT_END = '</font></center>';

var czurl = '/cz_26B05A54-ECBC-4fd3-863B-21B9FC3CC1162767F6D5-124E-4cab-9AE3-04DF832DDA885EC058D3-C442-4964-8AC7-EC24491ECA49';

var allpics = [];
var chongzhi = {};
var randompics = 4;

fs.readdir(__dirname + "/log/", function(err, files){
	for (var idx in files){
		dingdan_lists.push(files[idx].replace('gmlog_', '').replace('.log', ''));
	}

	dingdan_list_links = function(){
		var result = "<br/><b>订单存档</b><br />";
		for (var idx in dingdan_lists.reverse()){
			result += "<a href=\"/log/" + dingdan_lists[idx] +"\">"+dingdan_lists[idx]+"</a><br/>";
		}
		return result;
	}();

});

fs.readdir(PICPATH, function(err, files){
	for (var idx in files){
		allpics.push(files[idx]);
	}
});

//

function randomString(bits){
	var chars,rand,i,ret
	  chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'
	  ret=''
	  // in v8, Math.random() yields 32 pseudo-random bits (in spidermonkey it gives 53)
	  while(bits > 0){
	    rand=Math.floor(Math.random()*0x100000000) // 32-bit integer
	    // base 64 means 6 bits per character, so we use the top 30 bits from rand to give 30/6=5 characters.
	    for(i=26; i>0 && bits>0; i-=6, bits-=6) ret+=chars[0x3F & rand >>> i]}
	  return ret
}

Function.prototype.getstr = function() {  
    var lines = new String(this);  
    lines = lines.substring(lines.indexOf("/*") + 3, lines.lastIndexOf("*/"));  
    return lines;  
};

var lastday_link = '<pre><br /><b><a href="/money">余额显示＆充值</a></b>' +
'<br/><br/></pre>';

var header = function(){
/*
<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>全球联合订饭中心</title>
</head>
<body>
*/
}.getstr();

var tail = function(){
/*
</body>
</html>
*/
}.getstr();

var note = function(){
/*
<pre>
<h1>全球联合订饭中心为您服务</h1>
<b>说明</b>
本中心免费为人民服务
<b>2荤2素只要10元，再加1荤一共只需12元！</b>
首先必须填写真实姓名，否则订了饭却不知道谁订的
如需加荤，请勾上“加荤”
订两份请提交两次
订单不可撤销，下单请慎重
饭菜质量投诉电话：15618609537
请立即将本站加入收藏夹！

感谢您的惠顾，您可以<a href="/pic">随机获得神秘图片一张</a>
</pre>
*/
}.getstr() + lastday_link;

var form = note + function(){
/*
<form method = "post" action="/">
真实姓名<br />
<input name="username" type="text" maxlength="64" /><br />
<input type="checkbox" name="jiahun" value="yes" />加荤<br />
<input type="submit" value="提交"  />

</form><br/>
<pre>
<b>今日订单</b><br/>
*/
}.getstr();

var czform = '<form method = "post" action="' + czurl + function(){
/*
">
金额<br />
<input name="number" type="text" maxlength="64" /><br />
<input type="submit" value="提交"  />
</form>
*/
}.getstr();

var czform_cus = function(){
/*
<hr/>
<pre>

<b>充值</b>
向张瓅购买充值卡，张瓅会给你一个卡号
于是您就可以在这里输入卡号充值了
卡号对应了充值金额，并且是一次性的
请放心充值，一旦您离职、不再想订饭、钱花光了、失恋、生病等任何原因，都可以退回已充值的金额
您可以给自己充值也可以帮朋友或您暗恋的人充值
<form method = "post" action="/money">
真实姓名
<input name="username" type="text" maxlength="64" />
卡号
<input name="number" type="text" maxlength="1024" />
<input type="submit" value="充值"  />
</form>

<a href="/">返回首页</a>

</pre>
*/
}.getstr();

var dingfanjieshu = note + function(){
/*
<pre>

今日订饭已经结束
</pre>
<br/>
<pre>
<b>今日订单</b><br/>
*/
}.getstr();

var custom = function(){
/*
<pre>
<b>成功案例</b>
乔布斯：自从使用了全球联合订饭中心的服务，我们的产品销量大增，感谢全球联合订饭中心！

<b>我们的客户（部分）</b>
<img src="image/500.jpg"  align="left"/><img src="image/kfc.jpg"/><br/><img src="image/mdl.jpg" /><br/><img src="image/images.jpg"/>
</pre>

*/	
}.getstr();

var stooped = false;

var app = express.createServer();
app.configure(function(){
	app.use(express.methodOverride());
	app.use(express.bodyParser());
	app.use(express.cookieParser());
	app.use(express.session({secret:'123456', store:sessionStroe, key:'express.sid'}));
	app.use(gzippo.staticGzip(__dirname + '/public/resource'));	
	app.use(gzippo.compress());
	app.use(express.errorHandler({
		dumpExceptions:true,
		showStack:true
	}));
	app.use(app.router);
});

app.get('/stop', function(req, res){
	stooped = true;
	res.redirect('/');
});

app.get('/start', function(req, res){
	stooped = false;
	res.redirect('/');
});

app.get('/test', function(req, res){
	res.send(randomString(256));
});

function add_money(req, name, money_add){
	if (!money[name])
		money[name] = 0;
	money[name] += money_add;

	jsutil.SaveFile("money.js",
	"MONEY = \n"
	+ JSON.stringify(money).replace(/,/g, ',\n')
	+ ";\nmodule.exports = MONEY;");

	if (money_add > 0)
		gmlog.log(req.connection.remoteAddress + ' ' + name + " 充值 " + money_add.toString() + "， 余额 " + money[name].toString());
	else if (money_add < 0)
		gmlog.log(req.connection.remoteAddress + ' ' + name + " 扣款 " + Math.abs(money_add).toString() + "， 余额 " + money[name].toString());
}

function show_money(){
	var result = '<pre><b>余额</b><br/><br/>';
	for (var key in money){
		result += key;
		if (money[key] >= 0)
			result += ":" + money[key].toString() + '<br/>';
		else
			result += ':<font color="#FF0000">' + money[key].toString() + '</font><br/>';
	}
	result += '</pre>';
	return result;
}

function get_money(name){
	if (!money[name])
		return 0;
	return money[name];
}

function show_log(s){
	var log = s;
	var loglist = log.split('\n');
	var count = loglist.length-1;
	var money = 0;
	var typeconut = {};
	for (var idx in loglist){
		var one = loglist[idx];
		if (one.indexOf(type1) != -1){
			money += 10;
			if (!typeconut[type1])
				typeconut[type1] = 0;
			typeconut[type1]++;
		}
		else if (one.indexOf(type2) != -1){
			money += 12;
			if (!typeconut[type2])
				typeconut[type2] = 0;
			typeconut[type2]++;
		}
	}
	var info = "总额" + money.toString() + "元<br/>";
	for (var key in typeconut){
		info += key + " " + typeconut[key].toString() + "份<br />";
	}		
	return info + "<br />" + log;
}

app.get(czurl, function(req, res){
	res.send(header + czform + tail);
});

app.get('/money', function(req, res){
	res.send(header + show_money() + czform_cus + tail);
});

app.post(czurl, function(req, res){
	var number = req.body.number;
	if (!number){
		res.redirect(czurl);
		return;
	}	
	number = parseInt(number);
	var cardno = randomString(256) + (new Date().getTime()).toString();
	chongzhi[cardno] = number;
	res.send(cardno + ":" + number.toString());
});

app.post('/money', function(req, res){
	var username = req.body.username;
	var cardno = req.body.number;
	if (!username || !username.trim() || !cardno || !chongzhi[cardno]){
		res.send(header+PROMOT_START+'充值失败'+PROMOT_END+tail);
		return;
	}

	add_money(req, username.trim(), chongzhi[cardno]);
	delete chongzhi[cardno];
	res.redirect('/money');
});

app.get('/pic', function(req, res){
	try{
		if (!req.session.isok){
			res.send(header+PROMOT_START+'请先订饭'+PROMOT_END+tail);
			return;
		}
		if (!req.session.pics){
			res.send(header+PROMOT_START+'您的随机图片限额已用完，请再订饭，可再获取' + randompics.toString() + '个限额'+PROMOT_END+tail);
			return;
		}
		req.session.pics--;
		var idx = req.url.lastIndexOf('/');
		var name = req.url.substring(idx+1);
		var path = PICPATH + "/" + allpics[parseInt(Math.random() * 100000) % allpics.length];
		var s = fs.readFileSync(path);
		res.contentType('image/jpeg'); 
		res.send(s);
	}catch(err){
		res.send(header+PROMOT_START+'读取图片出错，请刷新'+PROMOT_END+tail);
	}
});

app.get('/log/*', function(req, res){
	try{
		var idx = req.url.lastIndexOf('/');
		var name = req.url.substring(idx+1);
		var path = __dirname + "/log/gmlog_" + name + ".log";
		var s = fs.readFileSync(path).toString();
		res.send(header + "<pre>" + show_log(s) + "</pre>" + tail);	
	}catch(err){
		res.send('');
	}
});

app.get('/', function(req, res){
	var now = new Date();
	var datestr = jsutil.dateToStr(now);
	var info = '';
	try{
		var log = fs.readFileSync(__dirname + "/log/gmlog_" + datestr + ".log").toString();
		info = show_log(log);	
	}catch(err){}
	if (stooped){
		res.send(header + dingfanjieshu + info  + dingdan_list_links + '</pre><hr/>' + custom  + tail
		);
	}else{
		res.send(header + form + info  + dingdan_list_links + '</pre><hr/>' + custom  + tail
		);
	}
});

app.post('/', function(req, res){
	var user = req.body.username;
	if (!user || !user.trim()){
		res.end(header+PROMOT_START+'名字不能为空'+PROMOT_END+tail);
		return;
	}
	user = user.trim();
	if (user.indexOf(type1) >= 0 || user.indexOf(type2) >= 0){
		res.end(header+PROMOT_START+'名字不可以是这个'+PROMOT_END+tail);
		return;
	}

	if (get_money(user) < 0){
		res.end(header+PROMOT_START+'本次订饭之前，您的余额已经为"' + get_money(user).toString() + '"，请先充值'+PROMOT_END+tail);
		return;
	}

	var jiahun = req.body.jiahun;
	if (jiahun == "yes"){
		var dingdan = type2;
		add_money(req, user, -12);
	}else{
		var dingdan = type1;
		add_money(req, user, -10);
	}
	gmlog.log(req.connection.remoteAddress + ' ' + user + " " + dingdan);
	req.session.isok = 1;
	if (!req.session.pics)
		req.session.pics = randompics;
	else
		req.session.pics += randompics;
	res.redirect('/');
});

function webapp(){}
webapp.app = app;
module.exports = webapp;
